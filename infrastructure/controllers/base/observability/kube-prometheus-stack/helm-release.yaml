apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 5m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: "79.4.1"
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus-stack
        namespace: flux-system
  values:
    nameOverride: ""
    fullnameOverride: ""
    namespaceOverride: observability

    # --- Désactiver les collecteurs doublons ---
    nodeExporter:
      enabled: false

    prometheus-node-exporter:
      enabled: false

    # Kubelet, cAdvisor, API server, etc. -> gérés par Alloy
    kubeApiServer:
      enabled: false

    kubelet:
      enabled: false

    kubeControllerManager:
      enabled: false

    kubeScheduler:
      enabled: false

    kubeProxy:
      enabled: false

    coreDns:
      enabled: false

    kubeDns:
      enabled: false

    kubeEtcd:
      enabled: false

    # --- Garder kube-state-metrics actif ---
    kubeStateMetrics:
      enabled: true

    # --- Prometheus Operator ---
    prometheusOperator:
      enabled: true

    # --- Prometheus ---
    prometheus:
      enabled: true
      prometheusSpec:
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false

        # Labels pour identifier le cluster
        externalLabels:
          cluster: homelab-alloy-cluster

        externalWriteReceiver: true

    # --- Alertmanager ---
    alertmanager:
      enabled: true
      config:
        global:
          resolve_timeout: 5m
        route:
          group_by: ['alertname', 'cluster', 'service']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
          receiver: default
        receivers:
          - name: default

    # --- Grafana ---
    grafana:
      enabled: true
      sidecar:
        dashboards:
          enabled: true
        datasources:
          enabled: true
