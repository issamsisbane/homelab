apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 5m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: "79.4.1"
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus-stack
        namespace: flux-system
  values:
    nameOverride: ""
    fullnameOverride: ""
    namespaceOverride: observability

    # --- DÃ©sactiver les collecteurs doublons ---
    nodeExporter:
      enabled: true

    # --- Garder kube-state-metrics actif ---
    kubeStateMetrics:
      enabled: true

    # --- Prometheus Operator ---
    prometheusOperator:
      enabled: true

    # --- Prometheus ---
    prometheus:
      enabled: true
      prometheusSpec:
        resources:
          requests:
            cpu: 200m
            memory: 200Mi
          limits:
            cpu: 600m
            memory: 600Mi
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false

        # Labels pour identifier le cluster
        externalLabels:
          cluster: homelab-alloy-cluster

    # --- Alertmanager ---
    alertmanager:
      enabled: true
      config:
        global:
          resolve_timeout: 5m
        route:
          group_by: ['alertname', 'cluster', 'service']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
          receiver: default
        receivers:
          - name: default

    # --- Grafana ---
    grafana:
      enabled: true
      sidecar:
        dashboards:
          enabled: true
        datasources:
          enabled: true
      additionalDataSources:
        - name: loki
          access: proxy
          type: loki
          url: http://loki-gateway.observability.svc.cluster.local:80/loki/api/v1/push
      resources:
        requests:
          cpu: 80m
          memory: 150Mi
        limits:
          cpu: 200m
          memory: 400Mi
